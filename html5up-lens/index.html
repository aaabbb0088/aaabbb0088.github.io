<!DOCTYPE HTML>
<!--
	Lens by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
    <title>閔琮 &hearts; 維妤</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
    <!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
    <noscript>
        <link rel="stylesheet" href="assets/css/noscript.css" />
    </noscript>
</head>
<script>
//onload
function btn_onloadAction() {
    let ref = fdatabase.ref(LottreyInputStatusPath)
    ref.once('value', function(snapshot) {
        var r = snapshot.val()
        if (r == null) {
            r = "Y"
            fdatabase.ref(LottreyInputStatusPath).set("Y")
        } else {
            r = r.toString()
        }
        if (r == "Y") {
            BTN_send.innerHTML = "送出"
            BTN_send.disabled = false
            LB_Name.innerHTML = "姓名"
            Txt_Name.style = "display:inline-block"
            LB_Blessing.style = "display:inline-block"
            Txt_Blessing.style = "width:100%;height:100px;"
            BTN_send.style = "width:100%;height:30px;"
        } else {
            BTN_send.innerHTML = "已截止"
            BTN_send.disabled = true
            LB_Name.innerHTML = "傳送祝福活動已截止"
            Txt_Name.style = "display:none"
            LB_Blessing.style = "display:none"
            Txt_Blessing.style = "display:none"
            BTN_send.style = "display:none"
            fdatabase.goOffline()
            fireApp.delete()
        }
    });
}
window.onload = btn_onloadAction;
</script>

<body class="is-loading-0 is-loading-1 is-loading-2">
    <!-- Main -->
    <div id="main">
        <!-- Header -->
        <header id="header">
            <h1>傳送祝福</h1>
            <p>感謝大家蒞臨我們的婚宴。
                <br> 現在，歡迎上傳對 閔琮&hearts;維妤 的祝福。
                <br> 我們將在午宴期間抽出多項禮品，敬請期待。
                <a href="URL"></a></p>
            <table border="1" width="100%" id="table">
                <tr>
                    <td>
                        <label id="LB_Name">資料驗證中...</label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="Txt_Name" type="text" name="input" align="center" style="display:none" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <br>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label id="LB_Blessing" style="display:none">給我們的祝福</label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <textarea id="Txt_Blessing" style="display:none"></textarea>
                    </td>
                </tr>
                <tr>
                    <td>
                        <br>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="BTN_send" value="0" type="button" style="display:none" onclick="send()" disabled="true">送出</button>
                    </td>
                </tr>
            </table>
        </header>
        <!-- Thumbnail -->
        <section id="thumbnails">
            <article>
                <a class="thumbnail" href="images/fulls/01.jpg" data-position="left center"><img src="images/thumbs/01.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
            <article>
                <a class="thumbnail" href="images/fulls/02.jpg"><img src="images/thumbs/02.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
            <article>
                <a class="thumbnail" href="images/fulls/03.jpg" data-position="top center"><img src="images/thumbs/03.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
            <article>
                <a class="thumbnail" href="images/fulls/04.jpg"><img src="images/thumbs/04.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
            <article>
                <a class="thumbnail" href="images/fulls/05.jpg" data-position="top center"><img src="images/thumbs/05.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
            <article>
                <a class="thumbnail" href="images/fulls/06.jpg"><img src="images/thumbs/06.jpg" alt="" /></a>
                <h2></h2>
                <p></p>
            </article>
        </section>
        <!-- Footer -->
        <footer id="footer">
            <ul class="copyright">
                <li>閔琮 &hearts; 維妤</li>
                <li>感謝你/妳的祝福</li>
            </ul>
        </footer>
    </div>
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    <script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyAsOPVm_WFDlbX4Uh47X_0rQ_RCFQK5Zj4",
        authDomain: "fir-ftitest.firebaseapp.com",
        databaseURL: "https://fir-ftitest.firebaseio.com",
        projectId: "firebase-ftitest",
        storageBucket: "firebase-ftitest.appspot.com",
        messagingSenderId: "579878934314"
    };
    let fireApp = firebase.initializeApp(config);
    </script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="assets/js/main.js"></script>
    <script>
    let table = document.getElementById("table")
    let LB_Name = document.getElementById("LB_Name")
    let Txt_Name = document.getElementById("Txt_Name")
    let LB_Blessing = document.getElementById("LB_Blessing")
    let Txt_Blessing = document.getElementById("Txt_Blessing")
    let BTN_send = document.getElementById("BTN_send")

    //firebase
    let fdatabase = fireApp.database()
    let LotteryPath = "Lottery"
    let LotteryNOCalPath = "Lottery/NOCal"
    let LotteryItemPath = "Lottery/item"
    let LottreyInputStatusPath = "Lottery/InputStatus"
    var autoID = ""
    let BlessingPath = "Blessing"
    let LotteryNOPath = "LotteryNO"
    let NamePath = "Name"
    let Timestamp_InputPath = "Timestamp_Input"
    let WinningPath = "Winning"

    function send() {
        if (Txt_Name.value == "") {
            Txt_Name.focus()
            return
        }
        if (Txt_Blessing.value == "") {
            Txt_Blessing.focus()
            return
        }

        let ref = fdatabase.ref(LottreyInputStatusPath)
        ref.once('value', function(snapshot) {
            var r = snapshot.val()
            if (r == null) {
                r = "Y"
                fdatabase.ref(LottreyInputStatusPath).set("Y")
            } else {
                r = r.toString()
            }
            if (r == "Y") {
                let ref = fdatabase.ref(LotteryNOCalPath)
                ref.once('value', function(snapshot) {
                    var r = snapshot.val()
                    if (r == null) {
                        r = "111"
                    } else {
                        r = r.toString()
                    }
                    var lotteryNo = new Number(r)

                    autoID = fdatabase.ref().child(LotteryItemPath).push().key
                    var updates = {}
                    updates[LotteryItemPath + '/' + autoID] = {
                        Blessing: Txt_Blessing.value,
                        LotteryNO: lotteryNo.toString(),
                        Name: Txt_Name.value,
                        Timestamp_Input: Math.floor(Date.now() / 1000).toString(),
                        Winning: ""
                    }
                    updates[LotteryNOCalPath] = lotteryNo + 1
                    fdatabase.ref().update(updates)

                    LB_Name.innerHTML = "感謝你/妳的祝福"
                    LB_Blessing.innerHTML = "別忘了，有抽獎活動喔！<br>你/妳的抽獎號碼是：<br><font size=\"6\">" + lotteryNo + "</font>"
                    Txt_Blessing.value = ""
                    Txt_Name.value = ""
                    Txt_Name.style = "display:none"
                    Txt_Blessing.style = "display:none"
                    BTN_send.innerHTML = "已送出"
                    BTN_send.disabled = true
                    fdatabase.goOffline()
                    fireApp.delete()
                });
            } else {
                BTN_send.innerHTML = "已截止"
                BTN_send.disabled = true
                LB_Name.innerHTML = "傳送祝福活動已截止"
                Txt_Name.style = "display:none"
                LB_Blessing.style = "display:none"
                Txt_Blessing.style = "display:none"
                BTN_send.style = "display:none"
                fdatabase.goOffline()
                fireApp.delete()
            }
        });
    }
    </script>
</body>

</html>